{
	"name": "leaderboard_evt",
	"events": [
		{
			"eventType": "variable",
			"name": "nickname",
			"type": "string",
			"initialValue": "\"\"",
			"comment": "Nickname of the player",
			"isStatic": false,
			"isConstant": false,
			"sid": 818320673779090
		},
		{
			"eventType": "block",
			"conditions": [
				{
					"id": "on-start-of-layout",
					"objectClass": "System",
					"sid": 770880636730892
				}
			],
			"actions": [
				{
					"id": "set-layer-visible",
					"objectClass": "System",
					"sid": 820819422950467,
					"parameters": {
						"layer": "\"leaderboard\"",
						"visibility": "visible"
					}
				},
				{
					"type": "script",
					"language": "javascript",
					"script": [
						"const root = typeof globalThis !== \"undefined\" ? globalThis : window",
						"if (!root.leaderboard && !root.__lbInit) {",
						"  root.__lbInit = true",
						"  const modes = [\"normal\", \"sudden death\", \"sorting frenzy\", \"target\"]",
						"  const maxEntries = 10",
						"  const keyForMode = (modeIndex) => {",
						"    const mode = modes[modeIndex] || modes[0]",
						"    return \"scores_\" + mode.toLowerCase().replace(\" \", \"_\")",
						"  }",
						"  const readScores = (modeIndex) => {",
						"    const key = keyForMode(modeIndex)",
						"    const raw = localStorage.getItem(key)",
						"    if (!raw) {",
						"      return []",
						"    }",
						"    try {",
						"      const data = JSON.parse(raw)",
						"      if (!Array.isArray(data)) {",
						"        return []",
						"      }",
						"      return data",
						"        .map((entry) => ({",
						"          username: String(entry.username || \"\"),",
						"          score: Number(entry.score),",
						"          ts: Number(entry.ts || 0),",
						"        }))",
						"        .filter((entry) => Number.isFinite(entry.score))",
						"    } catch (error) {",
						"      console.warn(\"[leaderboard] invalid localStorage\", error)",
						"      return []",
						"    }",
						"  }",
						"  const writeScores = (modeIndex, entries) => {",
						"    localStorage.setItem(keyForMode(modeIndex), JSON.stringify(entries))",
						"  }",
						"  const formatScores = (entries) =>",
						"    entries.map((entry) => `${entry.username} ${entry.score}`).join(\"\\n\")",
						"  root.leaderboard = {",
						"    submitScore(score, username, modeIndex) {",
						"      const safeScore = Number(score)",
						"      if (!Number.isFinite(safeScore)) {",
						"        console.warn(\"[leaderboard] invalid score\", score)",
						"        return formatScores(readScores(modeIndex))",
						"      }",
						"      const safeUsername = String(username || \"\").trim()",
						"      const entries = readScores(modeIndex)",
						"      entries.push({ username: safeUsername, score: safeScore, ts: Date.now() })",
						"      entries.sort((a, b) => b.score - a.score || a.ts - b.ts)",
						"      const topEntries = entries.slice(0, maxEntries)",
						"      writeScores(modeIndex, topEntries)",
						"      return formatScores(topEntries)",
						"    },",
						"    getScoresForMode(modeIndex) {",
						"      return formatScores(readScores(modeIndex))",
						"    },",
						"    getScoresAndStore() {",
						"      modes.forEach((mode, index) => {",
						"        if (!localStorage.getItem(keyForMode(index))) {",
						"          localStorage.setItem(keyForMode(index), \"[]\")",
						"        }",
						"      })",
						"      return modes.map((mode, index) => formatScores(readScores(index)))",
						"    },",
						"  }",
						"}",
						"const usersScoresInstance = runtime.objects.users_scores.getFirstInstance()",
						"const modeIndex = runtime.globalVars.gameMode >= 0 ? runtime.globalVars.gameMode : 0",
						"const leaderboard = root.leaderboard",
						"const setScores = (scores) => {",
						"  if (!usersScoresInstance) {",
						"    return",
						"  }",
						"  const output = (scores || \"\").trim() ? scores : \"empty\"",
						"  usersScoresInstance.text = output",
						"}",
						"const fetchScores = () => {",
						"  if (!leaderboard || typeof leaderboard.getScoresForMode !== \"function\") {",
						"    return false",
						"  }",
						"  const result = leaderboard.getScoresForMode(modeIndex)",
						"  if (result && typeof result.then === \"function\") {",
						"    result.then(setScores)",
						"  } else {",
						"    setScores(result)",
						"  }",
						"  return true",
						"}",
						"const retryUntilReady = (attemptsLeft) => {",
						"  if (fetchScores()) {",
						"    return",
						"  }",
						"  if (attemptsLeft <= 0) {",
						"    return",
						"  }",
						"  setTimeout(() => retryUntilReady(attemptsLeft - 1), 250)",
						"}",
						"retryUntilReady(20)",
						""
					]
				}
			],
			"sid": 831037580670931,
			"children": [
				{
					"eventType": "block",
					"conditions": [
						{
							"id": "compare-eventvar",
							"objectClass": "System",
							"sid": 186477799584629,
							"parameters": {
								"variable": "gameMode",
								"comparison": 0,
								"value": "-1"
							}
						}
					],
					"actions": [
						{
							"id": "set-layer-visible",
							"objectClass": "System",
							"sid": 212381315013777,
							"parameters": {
								"layer": "\"leaderboard_list\"",
								"visibility": "visible"
							}
						},
						{
							"id": "set-layer-visible",
							"objectClass": "System",
							"sid": 688678963902586,
							"parameters": {
								"layer": "\"leaderboard_input\"",
								"visibility": "invisible"
							}
						}
					],
					"sid": 249751780762856
				},
				{
					"eventType": "block",
					"conditions": [
						{
							"id": "else",
							"objectClass": "System",
							"sid": 374204465602784
						}
					],
					"actions": [
						{
							"id": "set-layer-visible",
							"objectClass": "System",
							"sid": 776170548504912,
							"parameters": {
								"layer": "\"leaderboard_list\"",
								"visibility": "invisible"
							}
						},
						{
							"id": "set-layer-visible",
							"objectClass": "System",
							"sid": 524616383722721,
							"parameters": {
								"layer": "\"leaderboard_input\"",
								"visibility": "visible"
							}
						}
					],
					"sid": 748567475975168
				},
				{
					"eventType": "block",
					"conditions": [],
					"actions": [],
					"sid": 516133320435374
				}
			]
		},
		{
			"eventType": "block",
			"conditions": [
				{
					"id": "on-created",
					"objectClass": "button",
					"sid": 543342998212677
				}
			],
			"actions": [
				{
					"id": "stop-animation",
					"objectClass": "button",
					"sid": 352719342953836
				}
			],
			"sid": 805449974379789
		},
		{
			"eventType": "block",
			"conditions": [
				{
					"id": "on-tap-object",
					"objectClass": "Touch",
					"sid": 269091004670461,
					"parameters": {
						"object": "submitText"
					}
				},
				{
					"id": "on-tap-object",
					"objectClass": "Touch",
					"sid": 964112805928331,
					"parameters": {
						"object": "button"
					}
				},
				{
					"id": "on-key-pressed",
					"objectClass": "Keyboard",
					"sid": 427480443135807,
					"parameters": {
						"key": 13
					}
				}
			],
			"actions": [
				{
					"id": "set-eventvar-value",
					"objectClass": "System",
					"sid": 239428422451378,
					"parameters": {
						"variable": "nickname",
						"value": "nicknameInpt.Text"
					}
				},
				{
					"type": "script",
					"language": "javascript",
					"script": [
						"const root = typeof globalThis !== \"undefined\" ? globalThis : window",
						"if (!root.leaderboard && !root.__lbInit) {",
						"  root.__lbInit = true",
						"  const modes = [\"normal\", \"sudden death\", \"sorting frenzy\", \"target\"]",
						"  const maxEntries = 10",
						"  const keyForMode = (modeIndex) => {",
						"    const mode = modes[modeIndex] || modes[0]",
						"    return \"scores_\" + mode.toLowerCase().replace(\" \", \"_\")",
						"  }",
						"  const readScores = (modeIndex) => {",
						"    const key = keyForMode(modeIndex)",
						"    const raw = localStorage.getItem(key)",
						"    if (!raw) {",
						"      return []",
						"    }",
						"    try {",
						"      const data = JSON.parse(raw)",
						"      if (!Array.isArray(data)) {",
						"        return []",
						"      }",
						"      return data",
						"        .map((entry) => ({",
						"          username: String(entry.username || \"\"),",
						"          score: Number(entry.score),",
						"          ts: Number(entry.ts || 0),",
						"        }))",
						"        .filter((entry) => Number.isFinite(entry.score))",
						"    } catch (error) {",
						"      console.warn(\"[leaderboard] invalid localStorage\", error)",
						"      return []",
						"    }",
						"  }",
						"  const writeScores = (modeIndex, entries) => {",
						"    localStorage.setItem(keyForMode(modeIndex), JSON.stringify(entries))",
						"  }",
						"  const formatScores = (entries) =>",
						"    entries.map((entry) => `${entry.username} ${entry.score}`).join(\"\\n\")",
						"  root.leaderboard = {",
						"    submitScore(score, username, modeIndex) {",
						"      const safeScore = Number(score)",
						"      if (!Number.isFinite(safeScore)) {",
						"        console.warn(\"[leaderboard] invalid score\", score)",
						"        return formatScores(readScores(modeIndex))",
						"      }",
						"      const safeUsername = String(username || \"\").trim()",
						"      const entries = readScores(modeIndex)",
						"      entries.push({ username: safeUsername, score: safeScore, ts: Date.now() })",
						"      entries.sort((a, b) => b.score - a.score || a.ts - b.ts)",
						"      const topEntries = entries.slice(0, maxEntries)",
						"      writeScores(modeIndex, topEntries)",
						"      return formatScores(topEntries)",
						"    },",
						"    getScoresForMode(modeIndex) {",
						"      return formatScores(readScores(modeIndex))",
						"    },",
						"    getScoresAndStore() {",
						"      modes.forEach((mode, index) => {",
						"        if (!localStorage.getItem(keyForMode(index))) {",
						"          localStorage.setItem(keyForMode(index), \"[]\")",
						"        }",
						"      })",
						"      return modes.map((mode, index) => formatScores(readScores(index)))",
						"    },",
						"  }",
						"}",
						"const nicknameInstance = runtime.objects.nicknameInpt.getFirstInstance()",
						"const nickname = nicknameInstance ? nicknameInstance.text : \"\"",
						"const modeIndex = runtime.globalVars.gameMode >= 0 ? runtime.globalVars.gameMode : 0",
						"const usersScoresInstance = runtime.objects.users_scores.getFirstInstance()",
						"const leaderboard = root.leaderboard",
						"console.log(\"[leaderboard] submit\", {",
						"  score: runtime.globalVars.score,",
						"  nickname,",
						"  gameMode: runtime.globalVars.gameMode,",
						"  modeIndex",
						"})",
						"const setScores = (scores) => {",
						"  if (!usersScoresInstance) {",
						"    return",
						"  }",
						"  const output = (scores || \"\").trim() ? scores : \"empty\"",
						"  usersScoresInstance.text = output",
						"}",
						"const fetchScores = () => {",
						"  if (!leaderboard || typeof leaderboard.getScoresForMode !== \"function\") {",
						"    return",
						"  }",
						"  const result = leaderboard.getScoresForMode(modeIndex)",
						"  if (result && typeof result.then === \"function\") {",
						"    result.then(setScores)",
						"  } else {",
						"    setScores(result)",
						"  }",
						"}",
						"const submitAndRefresh = () => {",
						"  const result = leaderboard.submitScore(runtime.globalVars.score, nickname, runtime.globalVars.gameMode)",
						"  if (result && typeof result.then === \"function\") {",
						"    result.then(fetchScores)",
						"  } else {",
						"    fetchScores()",
						"  }",
						"}",
						"if (leaderboard && typeof leaderboard.submitScore === \"function\") {",
						"  submitAndRefresh()",
						"} else {",
						"  console.warn(\"[leaderboard] submit skipped: leaderboard not ready\")",
						"  setTimeout(() => {",
						"    const retryLeaderboard = typeof globalThis !== \"undefined\" ? globalThis.leaderboard : window.leaderboard",
						"    if (retryLeaderboard && typeof retryLeaderboard.submitScore === \"function\") {",
						"      retryLeaderboard.submitScore(runtime.globalVars.score, nickname, runtime.globalVars.gameMode)",
						"      fetchScores()",
						"    }",
						"  }, 250)",
						"}",
						""
					]
				},
				{
					"id": "set-layer-visible",
					"objectClass": "System",
					"sid": 702972202846813,
					"parameters": {
						"layer": "\"leaderboard_list\"",
						"visibility": "visible"
					}
				},
				{
					"id": "set-layer-visible",
					"objectClass": "System",
					"sid": 865320760902270,
					"parameters": {
						"layer": "\"leaderboard_input\"",
						"visibility": "invisible"
					}
				}
			],
			"sid": 824254973504888,
			"isOrBlock": true
		},
		{
			"eventType": "block",
			"conditions": [
				{
					"id": "on-tap-object",
					"objectClass": "Touch",
					"sid": 831628520005823,
					"parameters": {
						"object": "leaderboardMod"
					}
				}
			],
			"actions": [
				{
					"type": "script",
					"language": "javascript",
					"script": [
						"",
						"const leaderboardModeinstance = runtime.objects.leaderboardMod.getFirstPickedInstance()",
						"",
						"const usersScoresInstance =  runtime.objects.users_scores.getFirstInstance()",
						"",
						"const leaderboard = typeof globalThis !== \"undefined\" ? globalThis.leaderboard : window.leaderboard",
						"const setScores = (scores) => {",
						"  if (!usersScoresInstance) {",
						"    return",
						"  }",
						"  const output = (scores || \"\").trim() ? scores : \"empty\"",
						"  usersScoresInstance.text = output",
						"}",
						"if (leaderboardModeinstance && leaderboard && typeof leaderboard.getScoresForMode === \"function\") {",
						"  const result = leaderboard.getScoresForMode(leaderboardModeinstance.instVars.mode)",
						"  if (result && typeof result.then === \"function\") {",
						"    result.then(setScores)",
						"  } else {",
						"    setScores(result)",
						"  }",
						"}",
						"",
						"",
						""
					]
				}
			],
			"sid": 927666575760240
		},
		{
			"eventType": "block",
			"conditions": [
				{
					"id": "on-tap-object",
					"objectClass": "Touch",
					"sid": 770384623927418,
					"parameters": {
						"object": "leaderboardMod"
					}
				},
				{
					"id": "compare-instance-variable",
					"objectClass": "leaderboardMod",
					"sid": 903463984344359,
					"parameters": {
						"instance-variable": "mode",
						"comparison": 0,
						"value": "-1"
					}
				}
			],
			"actions": [
				{
					"id": "go-to-layout",
					"objectClass": "System",
					"sid": 497184427295171,
					"parameters": {
						"layout": "start"
					}
				},
				{
					"id": "set-layer-visible",
					"objectClass": "System",
					"sid": 410748653089807,
					"parameters": {
						"layer": "\"leaderboard\"",
						"visibility": "invisible"
					}
				}
			],
			"sid": 682610656585955
		}
	],
	"sid": 249010360761534
}
